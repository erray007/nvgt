name: Kiral Release (FULL PAKET)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # ==========================================
  # üêß LINUX TANKI (Full Paket)
  # ==========================================
  linux_build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    # K√ºt√ºphaneler ve ƒ∞la√ßlama
    - name: Kutuphaneleri Yukle
      run: |
        sudo apt update
        sudo apt install -y build-essential libtool mesa-common-dev libxext-dev libxcursor-dev ladspa-sdk libxcomposite-dev libsystemd-dev autoconf libxxf86vm-dev libgl1-mesa-dev libxinerama-dev libx11-dev libltdl-dev libgtk-4-dev libglib2.0-dev libspeechd-dev libudev-dev linux-libc-dev libxrandr-dev libxrender-dev libwayland-dev pkg-config xorg-dev libglu1-mesa-dev libxft-dev libgsasl-dev clang python3-jinja2 zip gcc-aarch64-linux-gnu g++-aarch64-linux-gnu autoconf autoconf-archive automake libtool dos2unix

    - name: Izinleri Duzelt (Fix Permissions)
      run: |
        find . -type f \( -name "*.sh" -o -name "*.py" -o -name "configure" \) -exec dos2unix -q {} +
        chmod +x -R vcpkg
        find . -name "*.sh" -exec chmod +x {} \;

    - name: Bagimliliklari Derle
      run: python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        chmod +x build/build_linux.sh
        dos2unix build/build_linux.sh
        ./build/build_linux.sh ci

    # --- BURASI DEƒûƒ∞≈ûTƒ∞: KOMPLE PAKETLEME ---
    - name: Linux Full Paketle (Lib, Include, Stub ne varsa)
      run: |
        # Release klas√∂r√ºn√ºn i√ßine girip HER ≈ûEYƒ∞ paketliyoruz
        cd release
        tar -czf ../nvgt_linux_full.tar.gz .
        echo "Linux full paket hazir."

    # Release patlasa bile bu zip dosyasƒ±nƒ± Artifacts'tan indirirsin
    - uses: actions/upload-artifact@v4
      with:
        name: LINUX_FULL_DOSYALAR
        path: nvgt_linux_full.tar.gz
    # ----------------------------------------

  # ==========================================
  # ü™ü WINDOWS MAKƒ∞NESƒ∞ (Full Paket)
  # ==========================================
  windows_build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25.1'

    - name: Bagimliliklari Derle
      run: python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        choco install -y upx
        scons -s no_upx=0

    # --- WINDOWS FULL PAKETLEME ---
    - name: Windows Full Paketle (Zip Yap)
      run: |
        # PowerShell komutuyla release klas√∂r√ºndeki her ≈üeyi zipliyoruz
        Compress-Archive -Path release\* -DestinationPath nvgt_windows_full.zip
        echo "Windows full paket hazir."

    # Release patlasa bile buradan indirirsin
    - uses: actions/upload-artifact@v4
      with:
        name: WINDOWS_FULL_DOSYALAR
        path: nvgt_windows_full.zip
    # ------------------------------

  # ==========================================
  # üöÄ RELEASE OLU≈ûTURMA
  # ==========================================
  create_release:
    runs-on: ubuntu-latest
    needs: [linux_build, windows_build]
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Release Olustur
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Kiral S√ºr√ºm v${{ github.run_number }} (Full Paket)
          draft: false
          prerelease: false
          files: |
            artifacts/LINUX_FULL_DOSYALAR/nvgt_linux_full.tar.gz
            artifacts/WINDOWS_FULL_DOSYALAR/nvgt_windows_full.zip