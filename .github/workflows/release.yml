name: Kiral Release (Final Fix v2)

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  LC_ALL: C.UTF-8
  LANG: C.UTF-8

jobs:
  linux_build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive  # Recursive yaptık ki vcpkg içindeki her şeyi eksiksiz çeksin

    - name: Kutuphaneleri Yukle
      run: |
        sudo apt update
        sudo apt install -y build-essential libtool autoconf automake dos2unix python3-jinja2 zip pkg-config clang

    - name: Dosya Izinlerini Duzelt (Genel Temizlik)
      run: |
        # Sadece mevcut sh dosyalarına izin ver, olmayanları zorlama
        find . -name "*.sh" -exec chmod +x {} \; || true
        find . -name "configure" -exec chmod +x {} \; || true

    - name: Bagimliliklari Derle (VCPKG)
      run: |
        # Manuel chmod yapmiyoruz, Python scripti kendi halletsin
        python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        chmod +x build/build_linux.sh
        dos2unix build/build_linux.sh
        ./build/build_linux.sh ci

    # --- PAKETLEME ---
    - name: Full Paketle
      run: |
        cd release
        tar -czf ../nvgt_linux_full.tar.gz .
    
    - uses: actions/upload-artifact@v4
      with:
        name: LINUX_FULL_DOSYALAR
        path: nvgt_linux_full.tar.gz

  windows_build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25.1'

    - name: Bagimliliklari Derle
      run: python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        choco install -y upx
        scons -s no_upx=0

    - name: Windows Paketle
      run: |
        Compress-Archive -Path release\* -DestinationPath nvgt_windows_full.zip

    - uses: actions/upload-artifact@v4
      with:
        name: WINDOWS_FULL_DOSYALAR
        path: nvgt_windows_full.zip

  create_release:
    runs-on: ubuntu-latest
    needs: [linux_build, windows_build]
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Release Olustur
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Kiral Sürüm v${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/LINUX_FULL_DOSYALAR/nvgt_linux_full.tar.gz
            artifacts/WINDOWS_FULL_DOSYALAR/nvgt_windows_full.zip