name: Kiral Release (Final Fix)

on:
  workflow_dispatch:
  push:
    branches:
      - main

# TÜM SİSTEM İÇİN DİL AYARINI SABİTLİYORUZ (ÖNEMLİ!)
env:
  LC_ALL: C.UTF-8
  LANG: C.UTF-8

jobs:
  linux_build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    # .gitattributes ekledik ama yine de garanti olsun diye temizlik yapiyoruz
    - name: Kutuphaneleri Yukle ve Ortami Hazirla
      run: |
        sudo apt update
        sudo apt install -y build-essential libtool autoconf automake dos2unix python3-jinja2 zip pkg-config clang
        # Diğer kütüphaneler vcpkg ile hallediliyor, sistemi yormayalım

    - name: Dosya Izinlerini Zorla (Fix Permissions)
      run: |
        # Scriptlere çalıştırma izni ver
        find . -name "*.sh" -exec chmod +x {} \;
        find . -name "configure" -exec chmod +x {} \;
        # vcpkg klasörüne tam yetki ver
        chmod -R 777 vcpkg

    - name: Bagimliliklari Derle (VCPKG)
      run: |
        # Bootstrap sırasında hata verirse diye execute izni veriyoruz
        chmod +x vcpkg/bootstrap-vcpkg.sh
        python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        chmod +x build/build_linux.sh
        # build scriptini de temizleyelim
        dos2unix build/build_linux.sh
        ./build/build_linux.sh ci

    # --- PAKETLEME VE ARTIFACT ---
    - name: Full Paketle
      run: |
        cd release
        tar -czf ../nvgt_linux_full.tar.gz .
    
    - uses: actions/upload-artifact@v4
      with:
        name: LINUX_FULL_DOSYALAR
        path: nvgt_linux_full.tar.gz

  windows_build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    
    - uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25.1'

    - name: Bagimliliklari Derle
      run: python3 vcpkg/build_dependencies.py --archive

    - name: NVGT Derle
      run: |
        pip3 install scons
        choco install -y upx
        scons -s no_upx=0

    - name: Windows Paketle
      run: |
        Compress-Archive -Path release\* -DestinationPath nvgt_windows_full.zip

    - uses: actions/upload-artifact@v4
      with:
        name: WINDOWS_FULL_DOSYALAR
        path: nvgt_windows_full.zip

  create_release:
    runs-on: ubuntu-latest
    needs: [linux_build, windows_build]
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Release Olustur
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Kiral Sürüm v${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/LINUX_FULL_DOSYALAR/nvgt_linux_full.tar.gz
            artifacts/WINDOWS_FULL_DOSYALAR/nvgt_windows_full.zip